<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eksperimen Motor Imagery & Execution</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- IMPORT SUPABASE LIBRARY -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a202c; /* Dark background for focus */
            color: #e2e8f0;
            overflow-x: hidden;
        }
        .center-absolute {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            width: 100%;
        }
        .fixation-cross {
            font-size: 5rem;
            font-weight: bold;
            color: white;
        }
        /* Custom scrollbar for table */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #2d3748; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; 
        }
    </style>
</head>
<body>

    <!-- HALAMAN SETUP (Awal) -->
    <div id="setup-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-md border border-gray-700">
            <h1 class="text-2xl font-bold mb-6 text-center text-blue-400">Konfigurasi Eksperimen</h1>
            
            <form id="config-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">Nama / ID Peserta</label>
                    <input type="text" id="subject-id" required class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-blue-500 focus:outline-none" placeholder="Contoh: Peserta 01">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Tangan yang Diuji</label>
                    <select id="hand-selection" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-blue-500 focus:outline-none">
                        <option value="Kanan">Tangan Kanan (Right Hand)</option>
                        <option value="Kiri">Tangan Kiri (Left Hand)</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">Jenis Sesi</label>
                    <select id="session-type" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:border-blue-500 focus:outline-none">
                        <option value="ME_Latihan" data-trials="5" data-mode="ME">Latihan Motor Execution (5 Percobaan)</option>
                        <option value="ME_Utama" data-trials="15" data-mode="ME">Utama Motor Execution (15 Percobaan)</option>
                        <option value="MI_Latihan" data-trials="5" data-mode="MI">Latihan Motor Imagery (5 Percobaan)</option>
                        <option value="MI_Utama" data-trials="15" data-mode="MI">Utama Motor Imagery (15 Percobaan)</option>
                        <option value="Custom_20" data-trials="20" data-mode="ME">Custom Full Session (20 Percobaan - ME)</option>
                    </select>
                </div>

                <div class="pt-4 space-y-3">
                    <button type="submit" id="btn-start" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded transition duration-200">
                        Mulai Sesi
                    </button>
                    <button type="button" onclick="openDataScreen()" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-bold py-2 px-4 rounded transition duration-200 border border-gray-600">
                        üìÇ Lihat & Kelola Data
                    </button>
                </div>
            </form>
            
            <div id="loading-msg" class="hidden mt-4 text-xs text-yellow-400 text-center animate-pulse">
                Mengecek riwayat sesi sebelumnya untuk sinkronisasi...
            </div>
            <div class="mt-4 text-xs text-gray-500 text-center">
                Data disimpan per sesi (Ringkas).
            </div>
        </div>
    </div>

    <!-- HALAMAN DATA (Tabel Hasil - RINGKAS) -->
    <div id="data-screen" class="hidden min-h-screen p-6 bg-gray-900">
        <div class="max-w-6xl mx-auto">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-blue-400">Manajemen Data Eksperimen</h2>
                    <p class="text-gray-400 text-sm">Hapus data dengan hati-hati. Data yang dihapus tidak dapat dikembalikan.</p>
                </div>
                <div class="flex gap-3">
                    <!-- Tombol Download All -->
                    <button onclick="downloadAllHistoryCSV()" class="bg-green-700 hover:bg-green-600 text-white px-4 py-2 rounded flex items-center gap-2 border border-green-600 shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                        </svg>
                        <span>Unduh Semua (.csv)</span>
                    </button>
                    
                    <button onclick="switchScreen('setup')" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded flex items-center gap-2 border border-gray-600">
                        <span>‚Üê Kembali</span>
                    </button>
                </div>
            </div>

            <div class="bg-gray-800 rounded-lg shadow-xl border border-gray-700 overflow-hidden">
                <div class="overflow-x-auto max-h-[80vh]">
                    <table class="w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-700 text-gray-100 uppercase sticky top-0 z-10">
                            <tr>
                                <th class="p-4">Waktu</th>
                                <th class="p-4">Jenis Sesi</th>
                                <th class="p-4">Mode</th>
                                <th class="p-4">Tangan</th>
                                <th class="p-4 text-center">Jml Trial</th>
                                <th class="p-4 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="data-table-body" class="divide-y divide-gray-700">
                            <tr>
                                <td colspan="6" class="p-8 text-center text-gray-500">Memuat data...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <p class="mt-2 text-xs text-gray-500 text-right">* Menampilkan riwayat sesi.</p>
        </div>
    </div>

    <!-- MODAL DETAIL (Hidden by default) -->
    <div id="detail-modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-gray-800 rounded-lg shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-gray-600">
            <!-- Modal Header -->
            <div class="p-5 border-b border-gray-700 flex justify-between items-center bg-gray-900 rounded-t-lg">
                <h3 class="text-xl font-bold text-blue-400">Rincian Trial Sesi</h3>
                <button onclick="closeDetailModal()" class="text-gray-400 hover:text-white text-3xl font-bold leading-none">&times;</button>
            </div>
            
            <!-- Modal Body (Scrollable) -->
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Info Header Sesi -->
                <div id="modal-session-info" class="mb-6 grid grid-cols-2 gap-4 text-sm bg-gray-700 p-4 rounded border border-gray-600">
                    <!-- Diisi via JS -->
                </div>

                <h4 class="text-sm font-bold text-gray-400 mb-3 uppercase tracking-wider">Log Trial</h4>
                <div class="overflow-hidden rounded border border-gray-700">
                    <table class="w-full text-left text-sm text-gray-300">
                        <thead class="bg-gray-900 text-gray-100">
                            <tr>
                                <th class="p-3 w-16 text-center">No</th>
                                <th class="p-3">Instruksi</th>
                                <th class="p-3 text-right">Waktu Aksi (Main)</th>
                            </tr>
                        </thead>
                        <tbody id="modal-trial-list" class="divide-y divide-gray-700 bg-gray-800">
                            <!-- Diisi via JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="p-4 border-t border-gray-700 text-right bg-gray-900 rounded-b-lg">
                <button onclick="closeDetailModal()" class="bg-gray-600 hover:bg-gray-500 text-white px-6 py-2 rounded font-medium transition">Tutup</button>
            </div>
        </div>
    </div>

    <!-- HALAMAN EKSPERIMEN (Running) -->
    <div id="experiment-screen" class="hidden h-screen w-screen relative bg-black">
        <div class="absolute top-0 left-0 w-full h-1 bg-gray-800">
            <div id="progress-bar" class="h-full bg-blue-500 transition-all duration-300" style="width: 0%"></div>
        </div>
        <div class="absolute top-2 right-4 text-gray-500 text-sm">
            Trial: <span id="trial-counter">0</span>/<span id="total-trials">0</span>
        </div>

        <div class="center-absolute">
            <div id="fixation" class="hidden">
                <div class="fixation-cross">+</div>
            </div>
            <div id="instruction" class="hidden">
                <img id="instruction-img" src="" alt="Instruksi" class="mx-auto h-64 object-contain mb-4 rounded-lg border-2 border-gray-600">
                <h2 id="instruction-text" class="text-3xl font-bold text-yellow-400 uppercase tracking-wider"></h2>
            </div>
            <div id="action-phase" class="hidden">
                <div class="w-32 h-32 rounded-full border-4 border-green-500 flex items-center justify-center mx-auto mb-6 bg-green-900 bg-opacity-20 animate-pulse">
                    <span class="text-4xl font-bold text-green-400">GO</span>
                </div>
                <h2 id="action-text" class="text-4xl font-bold text-white uppercase"></h2>
            </div>
            <div id="rest-phase" class="hidden">
                <h2 class="text-2xl text-gray-400 mb-2">Istirahat</h2>
                <div class="text-6xl font-mono" id="rest-timer">5</div>
            </div>
        </div>
    </div>

    <!-- HALAMAN SELESAI (Result) -->
    <div id="result-screen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-lg text-center border border-gray-700">
            <h2 class="text-3xl font-bold text-green-400 mb-4">Sesi Selesai</h2>
            
            <div id="upload-status" class="mb-6 p-3 bg-gray-700 rounded text-sm text-yellow-300">
                Menyimpan data sesi ke Cloud...
            </div>

            <p class="mb-6 text-gray-400 text-sm">Seluruh data percobaan dalam sesi ini telah disatukan.</p>
            
            <div class="space-y-3">
                <button onclick="downloadCSV()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                    </svg>
                    Unduh CSV Lengkap
                </button>
                <button onclick="location.reload()" class="w-full bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded">
                    Kembali ke Menu Utama
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://rkekwnmwuybxzmbptcwh.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_5p4UmkOLs41OWf97B-He4g_A2MRqC7T'; 
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- KONFIGURASI GAMBAR ---
        const IMG_EXTENSION = "https://rkekwnmwuybxzmbptcwh.supabase.co/storage/v1/object/public/assets/Untitled%20design%20(7).png";
        const IMG_FLEXION = "https://rkekwnmwuybxzmbptcwh.supabase.co/storage/v1/object/public/assets/Untitled%20design%20(8).png";

        // --- STATE ---
        let config = {
            id: "",
            hand: "",
            sessionName: "",
            mode: "", 
            totalTrials: 0
        };

        let trials = []; 
        let currentTrialIndex = 0;
        let logs = []; 
        let fetchedSessions = [];

        // --- DOM ELEMENTS ---
        const screens = {
            setup: document.getElementById('setup-screen'),
            experiment: document.getElementById('experiment-screen'),
            result: document.getElementById('result-screen'),
            data: document.getElementById('data-screen')
        };
        
        const phases = {
            fixation: document.getElementById('fixation'),
            instruction: document.getElementById('instruction'),
            action: document.getElementById('action-phase'),
            rest: document.getElementById('rest-phase')
        };

        const elements = {
            trialCounter: document.getElementById('trial-counter'),
            totalTrials: document.getElementById('total-trials'),
            progressBar: document.getElementById('progress-bar'),
            instructionImg: document.getElementById('instruction-img'),
            instructionText: document.getElementById('instruction-text'),
            actionText: document.getElementById('action-text'),
            restTimer: document.getElementById('rest-timer'),
            uploadStatus: document.getElementById('upload-status'),
            dataTableBody: document.getElementById('data-table-body'),
            modal: document.getElementById('detail-modal'),
            modalInfo: document.getElementById('modal-session-info'),
            modalList: document.getElementById('modal-trial-list'),
            loadingMsg: document.getElementById('loading-msg'),
            btnStart: document.getElementById('btn-start')
        };

        // --- HANDLERS ---
        document.getElementById('config-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const selectEl = document.getElementById('session-type');
            const selectedOption = selectEl.options[selectEl.selectedIndex];

            config.id = document.getElementById('subject-id').value;
            config.hand = document.getElementById('hand-selection').value;
            config.sessionName = selectEl.value;
            config.totalTrials = parseInt(selectedOption.getAttribute('data-trials'));
            config.mode = selectedOption.getAttribute('data-mode');

            // Trigger Async Start Session
            startSession();
        });

        // --- LOGIC ---
        function shuffle(array) {
            let currentIndex = array.length, randomIndex;
            while (currentIndex != 0) {
                randomIndex = Math.floor(Math.random() * currentIndex);
                currentIndex--;
                [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
            }
            return array;
        }

        function generateSequence(count) {
            let seq = [];
            const half = Math.floor(count / 2);
            for(let i=0; i<half; i++) seq.push("Extension");
            for(let i=0; i<half; i++) seq.push("Flexion");
            if(count % 2 !== 0) seq.push(Math.random() > 0.5 ? "Extension" : "Flexion");
            return shuffle(seq);
        }

        function switchScreen(screenName) {
            Object.values(screens).forEach(s => s.classList.add('hidden'));
            if(screens[screenName]) screens[screenName].classList.remove('hidden');
        }

        function showPhaseElement(phaseName) {
            Object.values(phases).forEach(p => p.classList.add('hidden'));
            if(phaseName && phases[phaseName]) phases[phaseName].classList.remove('hidden');
        }

        // --- START SESSION WITH SYNC LOGIC ---
        async function startSession() {
            // UI Loading State
            elements.loadingMsg.classList.remove('hidden');
            elements.btnStart.disabled = true;
            elements.btnStart.innerText = "Memuat...";

            try {
                // 1. Cek apakah user ini sudah pernah melakukan jenis sesi ini sebelumnya (apapun tangannya)
                const { data: existingSession, error } = await supabaseClient
                    .from('experiment_sessions')
                    .select('trials_data')
                    .eq('subject_id', config.id)
                    .eq('session_type', config.sessionName)
                    .limit(1);

                if (existingSession && existingSession.length > 0) {
                    console.log("Ditemukan sesi sebelumnya. Menggunakan pola instruksi yang sama.");
                    const prevTrials = existingSession[0].trials_data;
                    
                    if (prevTrials && prevTrials.length >= config.totalTrials) {
                         trials = prevTrials.slice(0, config.totalTrials).map(t => t.instruction);
                    } else {
                        trials = generateSequence(config.totalTrials);
                    }
                } else {
                    console.log("Sesi baru. Membuat pola acak.");
                    trials = generateSequence(config.totalTrials);
                }

                currentTrialIndex = 0;
                logs = [];

                new Image().src = IMG_EXTENSION;
                new Image().src = IMG_FLEXION;

                elements.totalTrials.innerText = config.totalTrials;
                switchScreen('experiment');
                
                setTimeout(runTrial, 1000);

            } catch (err) {
                console.error("Error starting session:", err);
                alert("Gagal memulai sesi. Cek koneksi internet.");
            } finally {
                elements.loadingMsg.classList.add('hidden');
                elements.btnStart.disabled = false;
                elements.btnStart.innerText = "Mulai Sesi";
            }
        }

        function runTrial() {
            if (currentTrialIndex >= config.totalTrials) {
                finishSession();
                return;
            }

            const currentType = trials[currentTrialIndex];
            elements.trialCounter.innerText = currentTrialIndex + 1;
            elements.progressBar.style.width = `${((currentTrialIndex) / config.totalTrials) * 100}%`;
            
            showPhaseElement('fixation');
            setTimeout(() => {
                elements.instructionImg.src = currentType === 'Extension' ? IMG_EXTENSION : IMG_FLEXION;
                elements.instructionText.innerText = currentType === 'Extension' ? "WRIST EXTENSION" : "WRIST FLEXION";
                showPhaseElement('instruction');

                setTimeout(() => {
                    elements.actionText.innerText = config.mode === 'ME' ? "LAKUKAN GERAKAN" : "BAYANGKAN GERAKAN";
                    showPhaseElement('action');

                    const actionStartTime = new Date().toISOString();

                    setTimeout(() => {
                        logs.push({
                            trial: currentTrialIndex + 1,
                            instruction: currentType,
                            start_time: actionStartTime 
                        });

                        startRestPhase();
                    }, 4000);
                }, 2000);
            }, 2000);
        }

        function startRestPhase() {
            showPhaseElement('rest');
            let timeLeft = 5;
            elements.restTimer.innerText = timeLeft;
            const countdown = setInterval(() => {
                timeLeft--;
                elements.restTimer.innerText = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    currentTrialIndex++;
                    runTrial(); 
                }
            }, 1000);
        }

        function finishSession() {
            elements.progressBar.style.width = `100%`;
            switchScreen('result');
            saveDataToSupabase(); 
        }

        // --- SAVE TO DB ---
        async function saveDataToSupabase() {
            elements.uploadStatus.innerText = "Menyimpan data sesi ke Cloud...";
            elements.uploadStatus.className = "mb-6 p-3 bg-blue-900 rounded text-sm text-blue-200 animate-pulse";

            try {
                const sessionPayload = {
                    subject_id: config.id,
                    hand: config.hand,
                    session_type: config.sessionName,
                    mode: config.mode,
                    trials_data: logs 
                };

                const { data, error } = await supabaseClient
                    .from('experiment_sessions') 
                    .insert(sessionPayload);

                if (error) throw error;

                elements.uploadStatus.innerText = "‚úÖ Sesi berhasil disimpan!";
                elements.uploadStatus.className = "mb-6 p-3 bg-green-900 rounded text-sm text-green-200";
            } catch (err) {
                console.error("Supabase Error:", err);
                elements.uploadStatus.innerText = "‚ùå Gagal menyimpan. Pastikan tabel 'experiment_sessions' sudah dibuat.";
                elements.uploadStatus.className = "mb-6 p-3 bg-red-900 rounded text-sm text-red-200";
            }
        }

        // --- HISTORY LOGIC ---
        function openDataScreen() {
            switchScreen('data');
            fetchDataHistory();
        }

        async function fetchDataHistory() {
            elements.dataTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500 animate-pulse">Mengambil data sesi...</td></tr>`;

            const { data, error } = await supabaseClient
                .from('experiment_sessions') 
                .select('*')
                .order('created_at', { ascending: false })
                .limit(200);

            if (error) {
                elements.dataTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-400">Error: ${error.message}</td></tr>`;
                return;
            }
            if (!data || data.length === 0) {
                elements.dataTableBody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-gray-500">Belum ada sesi terekam.</td></tr>`;
                return;
            }

            fetchedSessions = data;

            // GROUP BY SUBJECT ID
            const groupedData = {};
            data.forEach((row, index) => {
                row.original_index = index; 
                if (!groupedData[row.subject_id]) groupedData[row.subject_id] = [];
                groupedData[row.subject_id].push(row);
            });

            elements.dataTableBody.innerHTML = '';
            
            Object.keys(groupedData).sort().forEach(subjectId => {
                const sessions = groupedData[subjectId];

                // Header Peserta dengan Tombol Hapus Peserta
                const headerTr = document.createElement('tr');
                headerTr.className = "bg-gray-700 text-blue-300 font-bold border-t-4 border-gray-900";
                headerTr.innerHTML = `
                    <td colspan="5" class="p-3 pl-4">
                        <span class="text-gray-400 font-normal text-xs uppercase tracking-wide mr-2">Peserta:</span>
                        ${subjectId}
                        <span class="ml-2 text-xs text-gray-500 bg-gray-800 px-2 py-0.5 rounded-full">${sessions.length} Sesi</span>
                    </td>
                    <td class="p-3 text-right">
                        <button onclick="deleteParticipant('${subjectId}')" class="bg-red-900 hover:bg-red-700 text-red-200 text-xs px-3 py-1 rounded border border-red-800 transition">
                            Hapus Semua
                        </button>
                    </td>
                `;
                elements.dataTableBody.appendChild(headerTr);

                // Baris Sesi dengan Tombol Hapus Sesi
                sessions.forEach(row => {
                    const date = new Date(row.created_at).toLocaleString('id-ID', {
                        day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                    });
                    const trialCount = row.trials_data ? row.trials_data.length : 0;
                    
                    const isPractice = row.session_type.includes('Latihan');
                    const opacityClass = isPractice ? "opacity-50" : "";

                    const tr = document.createElement('tr');
                    tr.className = `hover:bg-gray-750 transition-colors border-b border-gray-700 bg-gray-800 bg-opacity-40 ${opacityClass}`;
                    tr.innerHTML = `
                        <td class="p-4 pl-8 text-gray-400 whitespace-nowrap text-sm border-l-4 border-transparent hover:border-blue-500">${date}</td>
                        <td class="p-4 text-sm">${row.session_type}</td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs font-bold ${row.mode === 'ME' ? 'bg-blue-900 text-blue-200' : 'bg-purple-900 text-purple-200'}">${row.mode}</span>
                        </td>
                        <td class="p-4 text-sm font-medium ${row.hand === 'Kanan' ? 'text-green-300' : 'text-yellow-300'}">${row.hand}</td>
                        <td class="p-4 text-center text-sm"><span class="bg-gray-700 px-2 py-1 rounded">${trialCount}</span></td>
                        <td class="p-4 text-right">
                            <div class="flex justify-end gap-2">
                                <button onclick="viewSessionDetail(${row.original_index})" class="bg-indigo-600 hover:bg-indigo-500 text-white text-xs px-2 py-1 rounded font-bold transition shadow">Lihat</button>
                                <button onclick="downloadHistoryCSV(${row.original_index})" class="bg-gray-600 hover:bg-gray-500 text-white text-xs px-2 py-1 rounded font-bold transition shadow">CSV</button>
                                <button onclick="deleteSession(${row.original_index})" class="bg-red-600 hover:bg-red-500 text-white text-xs px-2 py-1 rounded font-bold transition shadow" title="Hapus Sesi Ini">Hapus</button>
                            </div>
                        </td>
                    `;
                    elements.dataTableBody.appendChild(tr);
                });
            });
        }

        // --- DELETE FUNCTIONS (NEW) ---

        async function deleteSession(index) {
            const row = fetchedSessions[index];
            if (!row) return;

            if (!confirm(`Apakah Anda yakin ingin menghapus sesi "${row.session_type}" pada tanggal ${new Date(row.created_at).toLocaleDateString()}?\nData tidak dapat dikembalikan.`)) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('experiment_sessions')
                    .delete()
                    .eq('id', row.id);

                if (error) throw error;
                alert("Sesi berhasil dihapus.");
                fetchDataHistory(); // Refresh table
            } catch (err) {
                console.error("Error deleting session:", err);
                alert("Gagal menghapus sesi. Pastikan kebijakan keamanan database mengizinkan delete.");
            }
        }

        async function deleteParticipant(subjectId) {
            if (!confirm(`PERINGATAN: Anda akan menghapus SEMUA data untuk peserta "${subjectId}".\nIni akan menghapus semua sesi (kanan/kiri, latihan/utama) untuk ID ini.\n\nApakah Anda yakin?`)) {
                return;
            }

            try {
                const { error } = await supabaseClient
                    .from('experiment_sessions')
                    .delete()
                    .eq('subject_id', subjectId);

                if (error) throw error;
                alert(`Semua data untuk ${subjectId} berhasil dihapus.`);
                fetchDataHistory(); // Refresh table
            } catch (err) {
                console.error("Error deleting participant:", err);
                alert("Gagal menghapus data peserta. Pastikan kebijakan keamanan database mengizinkan delete.");
            }
        }

        // --- FITUR EXPORT HORIZONTAL (FILTERED & BLOB FIX) ---
        async function downloadAllHistoryCSV() {
            const btn = document.querySelector('button[onclick="downloadAllHistoryCSV()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<span>‚è≥ Memproses...</span>`;
            btn.disabled = true;

            try {
                // Fetch data
                const { data, error } = await supabaseClient
                    .from('experiment_sessions') 
                    .select('*')
                    .order('subject_id', { ascending: true })
                    .order('created_at', { ascending: true }) 
                    .limit(1000);

                if (error) throw error;
                if (!data || data.length === 0) {
                    alert("Database kosong.");
                    return;
                }

                // FILTER: HANYA SESI UTAMA
                const filteredData = data.filter(s => !s.session_type.includes('Latihan'));

                if (filteredData.length === 0) {
                    alert("Tidak ada data sesi UTAMA. (Hanya ada sesi Latihan).");
                    return;
                }

                // Hitung max trials
                let maxTrials = 0;
                filteredData.forEach(s => {
                    if (s.trials_data && s.trials_data.length > maxTrials) {
                        maxTrials = s.trials_data.length;
                    }
                });

                // Buat Header
                let csvContent = "ParticipantID,Hand,SessionType,Mode,SessionDate,";
                for (let i = 1; i <= maxTrials; i++) {
                    csvContent += `Trial_${i}_Instruksi,Trial_${i}_Waktu_Action,`;
                }
                csvContent += "\n";

                // Isi Data
                filteredData.forEach(session => {
                    const sessionDate = new Date(session.created_at).toISOString();
                    let rowStr = `${session.subject_id},${session.hand},${session.session_type},${session.mode},${sessionDate},`;

                    const trials = session.trials_data || [];
                    for (let i = 0; i < maxTrials; i++) {
                        if (trials[i]) {
                            rowStr += `${trials[i].instruction},${trials[i].start_time},`;
                        } else {
                            rowStr += ",,";
                        }
                    }
                    csvContent += rowStr + "\n";
                });

                // --- FIX: GUNAKAN BLOB UNTUK DOWNLOAD ---
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement("a");
                link.href = url;
                const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
                link.setAttribute("download", `REKAP_UTAMA_MOTORIK_${timestamp}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Cleanup URL object
                setTimeout(() => URL.revokeObjectURL(url), 100);

            } catch (err) {
                console.error(err);
                alert("Gagal mengunduh: " + err.message);
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // --- MODAL & INDIVIDUAL CSV ---
        function viewSessionDetail(index) {
            const row = fetchedSessions[index];
            if(!row) return;

            const date = new Date(row.created_at).toLocaleString('id-ID', {
                    weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
            });

            elements.modalInfo.innerHTML = `
                <div><p class="text-gray-400 text-xs">Peserta</p><p class="text-white font-bold text-lg">${row.subject_id}</p></div>
                <div><p class="text-gray-400 text-xs">Waktu</p><p class="text-white font-bold">${date}</p></div>
                <div><p class="text-gray-400 text-xs">Jenis Sesi</p><p class="text-white font-bold">${row.session_type} (${row.mode})</p></div>
                <div><p class="text-gray-400 text-xs">Tangan</p><p class="text-white font-bold ${row.hand === 'Kanan' ? 'text-green-400' : 'text-yellow-400'}">${row.hand}</p></div>
            `;

            elements.modalList.innerHTML = '';
            const trials = row.trials_data || [];

            if (trials.length === 0) {
                elements.modalList.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-gray-500">Tidak ada detail trial.</td></tr>`;
            } else {
                trials.forEach(t => {
                    let timeDisplay = t.start_time;
                    try {
                        const d = new Date(t.start_time);
                        timeDisplay = d.toLocaleTimeString('id-ID', { hour12: false }) + `.${d.getMilliseconds()}`;
                    } catch(e) {}
                    const colorClass = t.instruction === 'Extension' ? 'text-green-400' : 'text-yellow-400';
                    const tr = document.createElement('tr');
                    tr.className = "hover:bg-gray-700 transition-colors";
                    tr.innerHTML = `
                        <td class="p-3 text-center border-b border-gray-700 text-gray-400">${t.trial}</td>
                        <td class="p-3 border-b border-gray-700 font-bold ${colorClass}">${t.instruction}</td>
                        <td class="p-3 text-right border-b border-gray-700 font-mono text-gray-400 text-xs">${timeDisplay}</td>
                    `;
                    elements.modalList.appendChild(tr);
                });
            }
            elements.modal.classList.remove('hidden');
        }

        function closeDetailModal() {
            elements.modal.classList.add('hidden');
        }

        elements.modal.addEventListener('click', function(e) {
            if (e.target === elements.modal) closeDetailModal();
        });

        function downloadHistoryCSV(index) {
            const row = fetchedSessions[index];
            if (!row) return alert("Data tidak ditemukan.");
            const trials = row.trials_data;
            if(!trials || trials.length === 0) return alert("Data kosong.");

            let csvContent = "ParticipantID,Hand,SessionType,Mode,TrialNumber,Instruction,Timestamp_Action\n";
            trials.forEach(t => {
                csvContent += `${row.subject_id},${row.hand},${row.session_type},${row.mode},${t.trial},${t.instruction},${t.start_time}\n`;
            });
            
            // FIX BLOB DOWNLOAD
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", `Data_${row.subject_id}_${row.session_type}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }

        function downloadCSV() {
            if (logs.length === 0) return alert("Tidak ada data.");
            let csvContent = "ParticipantID,Hand,SessionType,Mode,TrialNumber,Instruction,Timestamp_Action\n";
            logs.forEach(l => {
                csvContent += `${config.id},${config.hand},${config.sessionName},${config.mode},${l.trial},${l.instruction},${l.start_time}\n`;
            });

            // FIX BLOB DOWNLOAD
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            const timestamp = new Date().toISOString().slice(0,19).replace(/:/g,"-");
            link.setAttribute("download", `Data_${config.id}_${config.sessionName}_${timestamp}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            setTimeout(() => URL.revokeObjectURL(url), 100);
        }
    </script>
</body>
</html>
